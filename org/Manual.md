# Система генерации отчетов загрузки кластера

<!--ts-->
    * [Система генерации отчетов загрузки кластера](#Система-генерации-отчетов-загрузки-кластера)
    * [get-calendar-load](#get-calendar-load)
<!--te-->

Система обеспечивает анализ логов PBS (accounting), ведение БД задач PBS и генерацию отчетов как в текстовом виде так и в виде excel таблиц (с последующей загрузкой на сервер ИС ЦКП). Перед началом ведения БД и генерации отчетов требуется создать БД, для этого нужно выполнить sql-файл `create-tables.sql` (и внести пользователей в таблицу `ClusterUsers` для отчета по организациям). После этого нужно заполнить БД актуальными данными при помощи скрипта `job-db-update` или `get-calendar-load` с опцией `-u`. Генерацию отчетов и ведение БД рекомендуется осуществлять, используя программу `get-calendar-load`. Для своей работы она требует наличия конфигурационного файла, описание которого можно найти в разделе, посвещенном get-calendar-load.

## get-calendar-load

### Запуск

    get-calendar-load [-c <config>] [-n] [-u]

Параметры:

* `-c path` - путь к файлу конфигурации, если параметр не указан, то используется путь по умолчанию, *`/etc/pbstools.conf`*
* `-n` - генерация отчетов и загрузка на сервер без обновления БД (анализ новых логов и БД)
* `-u` - только обновление БД без генерации отчетов (если указать `-u` и `-n` одновременно, то никаких действий выполнено не будет)

### Файл конфигурации

Текстовый файл со строками следующего формата: `<параметр> <значение>`.

Список параметров:

* `dbuser` - пользователь БД, используемый приложением, по умолчанию *pbsacct*
* `dbpass` - пароль БД, по умолчанию пароль - *пустая строка*
* `ftpuser` - пользователь FTP, *не указан* по умолчанию
* `ftppass` - пароль FTP, *не указан* по умолчанию
* `FilerName` - основная часть имени временного файла, создаваемого приложением, по умолчанию - *"power8"*
* `StartDate` - дата, с которой начинается отчет (передается в формате `yyyy-mm-dd`), по умолчанию - *"2017-01-01"*
* `host` - адрес БД, по умолчанию *localhost*
* `wallHours` - количество часов в году, по умолчанию вычисляется исходя из значения `StartDate`
* `usersdbuser` - пользователь БД пользователей кластера. Если опустить этот параметр вместе с `usersdbpass`, то в качестве `usersdbuser` и `usersdbpass` будут использованы `dbuser` и `dbpass`
* `usersdbpass` - пароль БД пользователей кластера
* `usersdbhost` - адрес БД пользователей кластера, если хост не указан, то берется значение параметра `host`
* `accounting` - путь к папке с логами PBS, по умолчанию - *`$PBS_HOME/server_priv/accounting`*
* `ClusterName` - название кластера, пишется либо одним словом, либо в кавычках "" (кириллица допускается), по умолчанию *"Гибридный кластер"*

Также есть параметры, используемые другими скриптами:

* `MaxCPU` - всего процессоров на кластере, целое число
* `MaxThread` - всего нитей на кластере, целое число

### Описание

`get-calendar-load` служит для обновления БД задач PBS и для генерации отчетов, объединяя в себе остальные скрипты системы. При запуске в стандартном режиме

    get-calendar-load -c config.conf

будет произведен анализ лог-файла PBS за прошлые сутки и сгенерированы и посланы на удаленный сервер отчеты. Файлы отправляются по протоколу `ftp`. В процессе работы в папку `/tmp` загружается json-файл с данными об организациях, зарегистрированных в ИС ЦКП. Этот файл временный и удаляется при завершении генерации отчетов.

Скрипт `get-calendar-load` генерирует всего три отчета (формата `xlsx`):

1. Отчет по использованию календарного времени. Название строится по шаблону: `<год><FileName>.xlsx`.
2. Отчет загрузки кластера по пользователям. Название строится по шаблону: `<год><FileName>users.xlsx`
3. Отчет загрузки кластера по организациям. Название строится по шаблону: `<год><FileName>orgs.xlsx`

На время работы скрипта отчеты хранятся в папке `/tmp`, после чего - удаляются. Если требуется только обновить отчеты, без парсинга логов PBS, то для команды указывается `-n`:

    get-calendar-load -c config.conf -n
	
Если требуется только считать логи PBS и обновить БД, то для команды указывается `-u`:

get-calendar-load -c config.conf -u

Для работы `get-calendar-load` требует доступ к сайту ИС ЦКП и развернутую mysql БД `pbsacct` (`create-tables.sql` - скрипт на создание БД).

## agr-calendar-load

### Запуск

    agr-calendar-load [-d dbname] [-s dbhost] [-p dbpassword] [-u dbuser] [-b start_date] [-e end_date] [-i] [-m]

Параметры:

* `-d <name>` - имя БД, хранящей данные о задачах PBS, по умолчанию *pbsacct*
* `-s <host>` - адрес хоста БД с данными о задачах PBS, по умолчанию *localhost*
* `-u <username>` - имя пользователя БД для доступа к данным о задачах PBS, по умолчанию *pbsacct*
* `-p <password>` - пароль для доступа к БД с данными о задачах PBS, по умолчанию *пустая строка* (пароль не задан)
* `-b <date>` - дата, с которой начнется отчет (в формате `yyyy-mm-dd`), по умолчанию *2000-01-01*
* `-e <date>` - дата, на которой закончится отчет (в формате `yyyy-mm-dd`), по умолчанию *3000-01-01*, `-b` и `-e` задают даты включительно
* `-i` - если указан, то будет выводиться отладочная информация
* `-m` - если указан, то данные будут отображенны в минимальном формате

### Описание

`agr-calendar-load` показывает календарную загрузку кластера (сколько времени в сутки кластер был загружен). Выходные данные выводятся в `stdout`.

Скрипт поддерживает два формата вывода.

Полный формат:

    <yyyy-mm-dd> => WALLTIME <walltime> seconds SHARE <share>%


Минимальный формат:

    <yyyy-mm-dd> <walltime> <share>

где

* `<yyyy-mm-dd>` - дата позиции отчета,
* `<walltime>` - целое число, время, которое кластер был загружен в указаные сутки (в секундах),
* `<share>` - `<walltime>/86400` (`86400` - количество секунд в сутках), целое число (в процентах).

## agr-user-load-by-month

### Запуск

    agr-user-load-by-month [-s dbhost] [-d dbname] [-u dbuser] [-p dbpassword] [-b start_date] [-e end_date] [-i] [-m] [-n]

Параметры:

* `-s <host>` - адрес хоста БД с данными о задачах PBS, по умолчанию *localhost*
* `-d <name>` - имя БД с данными о задачах PBS, по умолчанию *pbsacct*
* `-u <username>` - имя пользоваьедя БД для доступа к данным о задачах PBS, по умолчанию *pbsacct*
* `-p <password>` - пароль пользователя БД, для доступа к данным о задачах PBS, по умолчанию пароль *не указан*
* `-b <date>` - месяц начала отчета, дата в формате `yyyy-mm`, по умолчанию *2000-01*
* `-e <date>` - месяц завершения отчета, дата в формате `yyyy-mm-dd`, по умолчанию *3000-01*
* `-i` - выводить отладочную информацию
* `-m` - выводить данные в минимальном формате
* `-n` - выводить месяца в численном виде

### Описание

Выводит данные об использовании ресурсов кластера сгруппированные по пользователям за месяц в stdout. Выводит как загрузку по ГПУ так и загрузку по ЦПУ.

Основной формат вывода:

    <month>: <summary_walltime> <summary_gpu_time> {<username> <walltime> <walltime_share>% <gpu_time> <gpu_time_share>% <cpu_time>}
	
где

* `<month>` - текущий месяц, отображается буквенным латинским сокращением (May, Jun и т.д.), если указан параметр численного отображения (`-n`), то отображается числом без заполнения нулями, т.е. "5", а не "05"
* `<summary_walltime>` - суммарное время выполнения всех задач в данном месяце, отображается целым числом в секундах
* `<summary_gpu_time>` - суммарное gpu время в данном месяце, отображается целым числом в секундах

часть, заключенная в `{}` повторяется для каждого пользователя, попавшего в отчетный месяц

* `<username>` - имя пользоватея
* `<walltime>` - суммарное время работы задач пользователя в данном месяце, отображается целым числом секунд
* `<walltime_share>` - доля сумарного времени пользователя в данном месяце, отображается числом с двумя знаками после запятой процентов
* `<gpu_time>` - суммарное gpu-время пользователя в данном месяце, отображается целым числом в секундах
* `<gpu_time_share>` - доля gpu-времени пользователя в данном месяце, отображается числом с двумя знаками после запятой в процентах
* `<cpu_time>` - суммарное cpu-время пользователя в данном месяце, отображается целым числом в секундах

Если указано использование минимального формата (`-m`), то из шаблона выходных данных исчезают лишние символы ":" и "%":

    <month> <summary_walltime> <summary_gpu_time> {<username> <walltime> <walltime_share> <gpu_time> <gpu_time_share> <cpu_time>}


## agr-orgs-load-by-month

### Запуск


    agr-orgs-load-by-month [-d dbname] [-p dbpassword] [-s dbhost] [-u dbuser] [-b start_date] [-e end_date] [-z users_dbuser] [-x users_dbpass] [-c users_dbhost] [-v users_dbname]  [-j json_file] [-i] [-m] [-n]


Параметры:

* `-d name` - имя БД для доступа к данным о задачах PBS, по умолчанию *pbsacct*
* `-p password` - пароль пользователя БД для доступа к данным о задачах PBS, по умолчанию пароль *отсутствует*
* `-s host` - хост БД для доступа к данным о задачах PBS, по умолчанию *localhost*
* `-u username` - пользователь БД для доступа к данным о задачах PBS, по умолчанию *pbsacct*
* `-b date` - дата начала отчета в формате `yyyy-mm`, по умолчанию *2000-01*
* `-e date` - дата конца отчета в формате `yyyy-mm`, по умолчанию *3000-01*
* `-z username` - имя пользователя БД для доступа к данным о пользователях кластера, по умолчанию *pbsacct*
* `-x password` - пароль пользователя БД для доступа к данным о пользователях кластера, по умолчанию пароль *отсутствует*
* `-c host` - хост БД для доступа к данным о пользователях кластера, по умолчанию *localhost*
* `-v name` - имя БД для доступа к данным о пользователях кластера, по умолчанию *pbsacct*
* `-j path` - пусть к JSON-файлу с данными об организациях ИС ЦКП, по умолчанию *не задан*
* `-i` - выводить отладочную информацию
* `-m` - выводить данные в минимальном формате
* `-n` - выводить месяца в численном виде

### Описание

Скрипт выводит данные об использовании ресурсов кластера сгруппированные по организвациям и по месяцам. Данные об принадлежности пользователей организациям берутся из БД и JSON файла с полями `user_id` и `org_id`. В БД должна быть таблица `ClusterUsers`, содержащая информацию о статусе пользователя кластера в ИС ЦКП (`user_id`, `org_id`). Если программе передан JSON файл с данными из ИС ЦКП, то программа будет определять принадлежность пользователя исходя из следующей последовательности `ClusterUsers.user_id => JSON.user_id => JSON.org_id`. Если же JSON не передан, или у текущей записи в `ClusterUsers` нет поля `user_id`, то данные об организации берутся из поля `ClusterUsers.org_id`.

Данные выводятся в stdout в формате:

    <month>: <summary_walltime> <summary_gpu_time> {<org_id> <walltime> <walltime_share>% <gpu_time> <gpu_time_share>%}

где

* `<month>` - месяц в сокращенном буквенном виде (Jun, May и т.д.)
* `<summary_walltime>` - суммарное время выполнения задач на кластере за месяц, отображается целым числом в секундах
* `<summary_gpu_time>` - суммарное gpu-время за месяц, отображается целым числом в секундах

блок заключенный в фигурные скобко повторяется, отражая данные по всем организациям, вошедшим в отчет за данный месяц

* `<org_id>` - id организации, отображается целым числом
* `<walltime>` - суммарное время выполнения задач организации на кластере, отображается целым числом в секундах
* `<walltime_share>` - доля `walltime` от `summary_walltime`, отображается числом с двумя знаками после запятой в процентах
* `<gpu_time>` - gpu-время организации на кластере, отображается целым числом в секундах
* `<gpu_time_share>` - доля `gpu_time` от `summary_gpu_time`, отображается числом с двумя знаками после запятой в процентах

Указание опции `-n` заменяет отображение месяцев на численное (May - 5, Dec - 12 и т.д.).
Указание опции `-m` убирает вспомогательные символы ':' и '%' из шаблона выходных данных:

    <month> <summary_walltime> <summary_gpu_time> {<org_id> <walltime> <walltime_share> <gpu_time> <gpu_time_share>}

## agr-calendar-load-excel

### Запуск

    agr-calendar-load-excel <year> <year_walltime> <path> <config> <data>

Параметры:

Параметры не имеют идентификаторов и определяются строгим порядком следования.

* `<year>` - год, который будет указан в отчете
* `<year_walltime>` - число часов (рабочих) в году
* `<path>` - имя файла, который будет сгенерирован программой (без расширения файла)
* `<config>` - путь к файлу конфигурации (файл конфигурации имеет ту же структуру, что и файл для `get-calendar-load`)
* `<data>` - данные, полученные из `agr-calendar-load -m` (флаг `-m` обязателен)

### Описание

`agr-calendar-load-excel` принимает в качестве входа (`stdin`) параметры и выход программы `agr-calendar-load` с опцией `-m`. Из конфигурационного файла скрипт извлекает поле `ClusterName`. По окончанию работы будет сгенерирован файл таблицы excel с отчетом.

## agr-user-load-by-month-excel

### Запуск

    agr-user-load-by-month-excel <year> <path> <config> <data>

Параметры:

Параметры не имеют идентификаторов и определяются строгим порядком следования.

* `<year>` - год, который будет указан в отчете
* `<path>` - имя файла, который будет сгенерирован программой (без расширения файла)
* `<config>` - путь к файлу конфигурации (файл конфигурации имеет ту же структуру, что и файл для `get-calendar-load`)
* `<data>` - данные, полученные из `agr-user-load-by-month -m` (флаг `-m` обязателен)

### Описание

`agr-user-load-by-month-excel` принимает в качестве входа вывод программы `agr-user-load-by-month` и генерирует excel таблицы с отчетом об использовании ресурсов кластера пользователями.
Из файла конфигурации скрипт извлекает параметры `ClusterName`, `MaxCPU` - общее число процессоров на кластере, `MaxThread` - общее число нитей на кластере, они используются для расчета утилизации ресурсов кластера.

## agr-orgs-load-by-month-excel

### Запуск

   agr-orgs-load-by-month-excel  <json> <year> <path> <config> <data>

Параметры:

* `<json>` - полное имя json файла (с расширением) с данными об организациях с ИС ЦКП
* `<year>` - год, который будет указан в отчете
* `<path>` - имя файла, который будет сгенерирован программой (без расширения)
* `<config>` - путь к файлу конфигурации (файл конфигурации имеет ту же структуру, что и файл для `get-calendar-load`)
* `<data>` - данные, полученные из `agr-orgs-load-by-month -m` (флаг `-m` обязателен)

### Описание

`agr-orgs-load-by-month-excel` принимает в качестве входа вывод программы `agr-orgs-load-by-month` и генерирует excel таблицы с отчетом об использовании ресурсов кластера организациями.
Из файла конфигурации скрипт извлекает параметр `ClusterName`.

## create-tables.sql

`create-tables.sql` - это `sql` скрипт для создания БД `pbsacct` и таблиц `ClusterUsers` и `Jobs`.

## job-db-update

    job-db-update [-d dbname] [-h hostname] [-p dbpasswd] [-s dbhost] [-t dbtable] [-u dbuser] {<accounting>}

Параметры:

* `-d` dbname - имя БД, по умолчанию *pbsacct*
* `-h` hostname - имя хоста, которое будет закреплено за проанализированными задачами, по умолчанию *hostname*
* `-p` dbpasswd - пароль для подключения к БД, по умолчанию *не задан*
* `-s` dbhost - хост БД, по умолчанию *localhost*
* `-t` dbtable - таблица, в которую будут занесены данные, по умолчанию *Jobs*
* `-u` dbuser - пользователь БД, по умолчанию *pbsacct*
* `{<accounting>}` - файл(ы) логов PBS

### Описание

Скрипт анализирует лог-файлы `PBS` и записывает новые данные в таблицу `Jobs`.
